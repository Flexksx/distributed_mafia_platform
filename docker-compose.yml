services:
  # =================================================================
  # DATABASE SERVICES
  # =================================================================

  # PostgreSQL for Character Service
  character-service-db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${CHARACTER_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${CHARACTER_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${CHARACTER_SERVICE_POSTGRES_DB}
    volumes:
      - character_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

      # PostgreSQL for Town Service
  town-service-db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${TOWN_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${TOWN_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${TOWN_SERVICE_POSTGRES_DB}
    volumes:
      - town_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # PostgreSQL for User Management Service
  user-management-db:
    image: postgres:16
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${USER_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${USER_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${USER_SERVICE_POSTGRES_DB}
    volumes:
      - user_management_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # PostgreSQL for Game Service
  game-service-db:
    image: postgres:16
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${GAME_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${GAME_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${GAME_SERVICE_POSTGRES_DB}
    volumes:
      - game_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # PostgreSQL for Task Service
  task-service-db:
    image: postgres:16-alpine
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${TASK_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${TASK_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${TASK_SERVICE_POSTGRES_DB}
    ports:
      - "5001:5432"
    volumes:
      - task_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - mafia-network

  # PostgreSQL for Voting Service
  voting-service-db:
    image: postgres:16-alpine
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${VOTING_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${VOTING_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${VOTING_SERVICE_POSTGRES_DB}
    ports:
      - "5002:5432"
    volumes:
      - voting_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - mafia-network

  # PostgreSQL for Shop Service
  shop-service-db:
    image: cebanvasile1/shop-service-db:latest
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${SHOP_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${SHOP_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${SHOP_SERVICE_POSTGRES_DB}
    volumes:
      - shop_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # PostgreSQL for Roleplay Service
  roleplay-service-db:
    image: cebanvasile1/roleplay-postgres:latest
    platform: linux/amd64
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${ROLEPLAY_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${ROLEPLAY_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${ROLEPLAY_SERVICE_POSTGRES_DB}
      LANG: en_US.utf8
    volumes:
      - roleplay_service_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # =================================================================
  # APPLICATION SERVICES
  # =================================================================

  # Redis Cache for Gateway
  gateway-cache:
    image: redis:7-alpine
    platform: linux/amd64
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379" # Expose Redis to localhost
    volumes:
      - gateway_cache_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mafia-network

  # Character Service (Spring Boot + Java)
  character-service:
    image: liviutofan/character-service:latest
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      character-service-db:
        condition: service_healthy
      user-management-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://character-service-db:${CHARACTER_SERVICE_POSTGRES_PORT}/${CHARACTER_SERVICE_POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${CHARACTER_SERVICE_POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${CHARACTER_SERVICE_POSTGRES_PASSWORD}
      SERVER_PORT: ${CHARACTER_SERVICE_PORT}
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
    ports:
      - "${CHARACTER_SERVICE_PORT}:${CHARACTER_SERVICE_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$SERVER_PORT/actuator/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 45s
    networks:
      - mafia-network

  # Town Service (Spring Boot + Java)
  town-service:
    image: liviutofan/town-service:latest
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      town-service-db:
        condition: service_healthy
      user-management-service:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://town-service-db:${TOWN_SERVICE_POSTGRES_PORT}/${TOWN_SERVICE_POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${TOWN_SERVICE_POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${TOWN_SERVICE_POSTGRES_PASSWORD}
      SERVER_PORT: ${TOWN_SERVICE_PORT}
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
    ports:
      - "${TOWN_SERVICE_PORT}:${TOWN_SERVICE_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$SERVER_PORT/actuator/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 45s
    networks:
      - mafia-network

  # User Management Service (Express.js + TypeScript)
  user-management-service:
    image: flexksx/mafia_user_management_service:latest
    platform: linux/amd64
    restart: unless-stopped
    deploy:
      replicas: 2
    depends_on:
      user-management-db:
        condition: service_healthy
    environment:
      PORT: ${USER_SERVICE_PORT}
      GRPC_PORT: ${USER_SERVICE_GRPC_PORT}
      NODE_ENV: production
      DATABASE_URL: postgresql://${USER_SERVICE_POSTGRES_USER}:${USER_SERVICE_POSTGRES_PASSWORD}@user-management-db:${USER_SERVICE_POSTGRES_PORT}/${USER_SERVICE_POSTGRES_DB}?schema=public
      POSTGRES_USER: ${USER_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${USER_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${USER_SERVICE_POSTGRES_DB}
      POSTGRES_PORT: ${USER_SERVICE_POSTGRES_PORT}
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
      LOG_LEVEL: info
      SERVICE_DISCOVERY_URL: http://service-discovery:3004
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      MESSAGE_BROKER_URL: "http://message-broker:${MESSAGE_BROKER_PORT}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$PORT/v1/users >/dev/null 2>&1 || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - mafia-network

  # Game Service (Express.js + TypeScript)
  game-service:
    image: flexksx/mafia-game-service:latest
    platform: linux/amd64
    restart: unless-stopped
    deploy:
      replicas: 2
    depends_on:
      game-service-db:
        condition: service_healthy
      user-management-service:
        condition: service_healthy
    environment:
      PORT: ${GAME_SERVICE_PORT}
      GRPC_PORT: ${GAME_SERVICE_GRPC_PORT}
      NODE_ENV: production
      USER_SERVICE_URL: http://user-management-service:${USER_SERVICE_PORT}
      DATABASE_URL: postgresql://${GAME_SERVICE_POSTGRES_USER}:${GAME_SERVICE_POSTGRES_PASSWORD}@game-service-db:${GAME_SERVICE_POSTGRES_PORT}/${GAME_SERVICE_POSTGRES_DB}?schema=public
      POSTGRES_USER: ${GAME_SERVICE_POSTGRES_USER}
      POSTGRES_PASSWORD: ${GAME_SERVICE_POSTGRES_PASSWORD}
      POSTGRES_DB: ${GAME_SERVICE_POSTGRES_DB}
      POSTGRES_PORT: ${GAME_SERVICE_POSTGRES_PORT}
      CROSS_SERVICE_API_KEY: ${GATEWAY_SERVICE_TO_SERVICE_SECRET}
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
      LOG_LEVEL: info
      SERVICE_DISCOVERY_URL: http://service-discovery:3004
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      MESSAGE_BROKER_URL: http://message-broker:${MESSAGE_BROKER_PORT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$PORT/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - mafia-network

  # Task Service (Express.js + TypeScript + Prisma)
  task-service:
    image: rayderr/mafia_liviu_task_service:latest
    platform: linux/amd64
    restart: unless-stopped
    deploy:
      replicas: 2
    depends_on:
      task-service-db:
        condition: service_healthy
      game-service:
        condition: service_healthy
      user-management-service:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      PORT: ${TASK_SERVICE_PORT}
      NODE_ENV: production
      DATABASE_URL: postgresql://${TASK_SERVICE_POSTGRES_USER}:${TASK_SERVICE_POSTGRES_PASSWORD}@task-service-db:${TASK_SERVICE_POSTGRES_PORT}/${TASK_SERVICE_POSTGRES_DB}?schema=public
      APP_PORT: ${TASK_SERVICE_PORT}
      JWT_SECRET: production-jwt-secret-change-me
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
      SERVICE_DISCOVERY_URL: http://service-discovery:${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      SERVICE_HOST: task-service
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$APP_PORT/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - mafia-network
    # Run migrations as root, then switch to nodejs user for the app
    user: root
    command: sh -c "npx prisma db push --skip-generate --force-reset --accept-data-loss && su -s /bin/sh nodejs -c 'node dist/src/server/index.js'"

  # Voting Service (Express.js + TypeScript + Prisma)
  voting-service:
    image: rayderr/mafia_liviu_voting_service:latest
    platform: linux/amd64
    restart: unless-stopped
    deploy:
      replicas: 2
    depends_on:
      voting-service-db:
        condition: service_healthy
      game-service:
        condition: service_healthy
      user-management-service:
        condition: service_healthy
      task-service:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      PORT: ${VOTING_SERVICE_PORT}
      NODE_ENV: production
      DATABASE_URL: postgresql://${VOTING_SERVICE_POSTGRES_USER}:${VOTING_SERVICE_POSTGRES_PASSWORD}@voting-service-db:${VOTING_SERVICE_POSTGRES_PORT}/${VOTING_SERVICE_POSTGRES_DB}?schema=public
      APP_PORT: ${VOTING_SERVICE_PORT}
      JWT_SECRET: production-jwt-secret-change-me
      TIE_BREAK_METHOD: RANDOM
      GATEWAY_URL: http://gateway:${GATEWAY_PORT}
      SERVICE_DISCOVERY_URL: http://service-discovery:${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      SERVICE_HOST: voting-service
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$APP_PORT/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - mafia-network
    user: root
    command: sh -c "npx prisma db push --skip-generate --force-reset --accept-data-loss && su -s /bin/sh nodejs -c 'node dist/src/server/index.js'"

    # Shop Service (Spring Boot + Java) - Instance 1
  shop-service:
    image: cebanvasile1/shop-service:2.0.6
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      shop-service-db:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://shop-service-db:${SHOP_SERVICE_POSTGRES_PORT}/${SHOP_SERVICE_POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${SHOP_SERVICE_POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${SHOP_SERVICE_POSTGRES_PASSWORD}
      SERVER_PORT: ${SHOP_SERVICE_PORT}
      SERVICE_DISCOVERY_ENABLED: "true"
      SERVICE_DISCOVERY_URL: http://service-discovery:${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      SERVICE_HEALTH_ENDPOINT: /health
    networks:
      - mafia-network
    deploy:
      replicas: 2
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$SERVER_PORT/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  roleplay-service:
    image: cebanvasile1/roleplay-service:latest
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      roleplay-service-db:
        condition: service_healthy
      service-discovery:
        condition: service_started
    environment:
      DB_HOST: roleplay-service-db
      DB_PORT: ${ROLEPLAY_SERVICE_POSTGRES_PORT}
      DB_NAME: ${ROLEPLAY_SERVICE_POSTGRES_DB}
      DB_USERNAME: ${ROLEPLAY_SERVICE_POSTGRES_USER}
      DB_PASSWORD: ${ROLEPLAY_SERVICE_POSTGRES_PASSWORD}
      SERVER_PORT: ${ROLEPLAY_SERVICE_PORT}
      SERVICE_DISCOVERY_URL: http://service-discovery:${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_ENABLED: ${SERVICE_DISCOVERY_ENABLED:-true}
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      SERVICE_HEALTH_ENDPOINT: /health
    networks:
      - mafia-network
    deploy:
      replicas: 2
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:$$SERVER_PORT/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # =====
  # GATEWAY
  # =====
  gateway:
    image: flexksx/mafia_api_gateway:main
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      gateway-cache:
        condition: service_healthy
      message-broker:
        condition: service_healthy

    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    environment:
      PORT: ${GATEWAY_PORT}
      MESSAGE_BROKER_URL: "http://message-broker:${MESSAGE_BROKER_PORT}"
      USER_SERVICE_URL: "http://user-management-service:${USER_SERVICE_PORT}"
      GAME_SERVICE_URL: "http://game-service:${GAME_SERVICE_PORT}"
      TASK_SERVICE_URL: "http://task-service:${TASK_SERVICE_PORT}"
      VOTING_SERVICE_URL: "http://voting-service:${VOTING_SERVICE_PORT}"
      JWT_SECRET: ${GATEWAY_JWT_SECRET}
      JWT_ALGORITHM: ${GATEWAY_JWT_ALGORITHM}
      JWT_EXPIRES_SECONDS: ${GATEWAY_JWT_EXPIRES_SECONDS}
      SERVICE_TO_SERVICE_SECRET: ${GATEWAY_SERVICE_TO_SERVICE_SECRET}
      REDIS_HOST: gateway-cache
      REDIS_PORT: 6379
      REDIS_DB: 0
      CACHE_TTL_SECONDS: ${GATEWAY_CACHE_TTL_SECONDS}
      HTTP_TIMEOUT_SECONDS: "5"
      MAX_CONCURRENCY: "200"
      SERVICE_DISCOVERY_URL: http://service-discovery:${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
      SERVICE_HEARTBEAT_INTERVAL: ${SERVICE_HEARTBEAT_INTERVAL_SECONDS}
      LOAD_BALANCING_STRATEGY: ${LOAD_BALANCING_STRATEGY}

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:$$PORT/ >/dev/null 2>&1 || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - mafia-network

  # SERVICE DISCOVERY
  # ================
  service-discovery:
    image: flexksx/mafia_service_discovery:latest
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "${SERVICE_DISCOVERY_PORT:-3004}:3004"
    environment:
      SERVICE_DISCOVERY_PORT: ${SERVICE_DISCOVERY_PORT}
      SERVICE_DISCOVERY_HOST: ${SERVICE_DISCOVERY_HOST}
      HEALTH_CHECK_INTERVAL_SECONDS: ${HEALTH_CHECK_INTERVAL_SECONDS}
      HEALTH_CHECK_TIMEOUT_SECONDS: ${HEALTH_CHECK_TIMEOUT_SECONDS}
      CRITICAL_LOAD_THRESHOLD: ${CRITICAL_LOAD_THRESHOLD}
      SERVICE_REGISTRATION_TTL_SECONDS: ${SERVICE_REGISTRATION_TTL_SECONDS}
      SERVICE_HEARTBEAT_INTERVAL_SECONDS: ${SERVICE_HEARTBEAT_INTERVAL_SECONDS}
      LOG_LEVEL: INFO
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -qO- http://localhost:3004/health >/dev/null 2>&1 || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - mafia-network

  # MESSAGE BROKER
  # ==============
  message-broker:
    build: ./message_broker # Build our modified version locally
    platform: linux/amd64
    restart: unless-stopped
    depends_on:
      gateway-cache:
        condition: service_healthy
      service-discovery:
        condition: service_healthy
    ports:
      - "8002:8002"
    environment:
      # Broker Configuration
      BROKER_HOST: 0.0.0.0
      BROKER_PORT: 8002
      BROKER_NAME: message-broker

      # Redis Configuration (reuse gateway cache)
      REDIS_HOST: gateway-cache
      REDIS_PORT: 6379
      REDIS_DB: 1
      REDIS_PASSWORD: ""

      # Service Discovery
      SERVICE_DISCOVERY_URL: http://service-discovery:3004
      SERVICE_DISCOVERY_SECRET: ${SERVICE_DISCOVERY_SECRET}

      # Message Configuration
      MAX_MESSAGE_SIZE: 1048576
      MESSAGE_TTL: 3600
      MAX_QUEUE_SIZE: 10000
      MAX_MESSAGE_RETRIES: 5
      RETRY_DELAY_SECONDS: 5
      DLQ_ENABLED: "true"

      # Load Balancing
      LOAD_BALANCING_STRATEGY: least_load
      HEALTH_CHECK_INTERVAL_SECONDS: 30
      HEALTH_CHECK_TIMEOUT_SECONDS: 5

      # Circuit Breaker
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
      CIRCUIT_BREAKER_SUCCESS_THRESHOLD: 2
      CIRCUIT_BREAKER_TIMEOUT_SECONDS: 60
      CIRCUIT_BREAKER_HALF_OPEN_MAX_REQUESTS: 3

      # Grade 5: Failover
      FAILOVER_ENABLED: "true"
      FAILOVER_FAILURE_THRESHOLD: 3
      FAILOVER_RESET_TIMEOUT: 10
      FAILOVER_MAX_RETRY_ATTEMPTS: 3

      # Grade 6 & 7: Durable Queues
      DATABASE_URL: sqlite:///./message_broker.db
      RETRY_BACKOFF_MULTIPLIER: 2.0

      # Grade 8: Two-Phase Commit
      TRANSACTION_TIMEOUT: 30
      TRANSACTION_MAX_PARTICIPANTS: 10

      # Thread Pool
      THREAD_POOL_MAX_WORKERS: 50
      REQUEST_TIMEOUT: 30

      # Monitoring
      METRICS_ENABLED: "true"
      LOG_LEVEL: INFO
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:8002/health'')"',
        ]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - mafia-network

  # MONITORING STACK
  # ===============

  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:latest
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
    networks:
      - mafia-network

  # Grafana - Visualization and dashboards
  grafana:
    image: grafana/grafana:latest
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3007}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - mafia-network

# =================================================================
# NETWORKS AND VOLUMES
# =================================================================

volumes:
  user_management_data:
    driver: local
  game_service_data:
    driver: local
  task_service_data:
    driver: local
  voting_service_data:
    driver: local
  shop_service_data:
    driver: local
  roleplay_service_data:
    driver: local
  character_service_data:
    driver: local
  town_service_data:
    driver: local
  gateway_cache_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  mafia-network:
    driver: bridge
